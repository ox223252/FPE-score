<!DOCTYPE html>
<html>
	<% include head %>
	<body>
		<% include nav %>
		<section>
			<div>
				<div>
					<input id="user" type="text" placeholder="new user" onkeyup="exist(this);"/>
					<select id="categorie">
						<option disabled selected></option>
						<option value="microbe">microbe</option>
						<option value="poussin">poussin</option>
						<option value="bejamin">bejamin</option>
						<option value="minime">minime</option>
						<option value="cadet">cadet</option>
						<option value="senior">senior</option>
						<option value="veterant">veterant</option>
					</select>
					<select id="genre">
						<option disabled selected></option>
						<option value="homme">homme</option>
						<option value="femme">femme</option>
					</select>
					<input id="club" onkeyup="getClub(this.value,'clubSugest', this.id);" type="text" >
					<div id="clubSugest" style="display:none">
						
					</div>
					<button onclick="addUser()">Ok</button>
				</div>
			</div>
		</section>
		<script type="text/javascript"> // password
			function addUser ( )
			{
				let user = document.getElementById( 'user' );
				let categorie = document.getElementById ( 'categorie' ).value;
				let genre = document.getElementById ( 'genre' ).value;
				let club = document.getElementById ( 'club' ).value;

				if ( ( user.value == "" ) ||
					!categorie ||
					!genre )
				{
					user.style.color = "";
					return;
				}

				let xhr = new XMLHttpRequest();

				xhr.open('POST', '/addUser' );
				xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

				xhr.addEventListener ( 'readystatechange', function ( )
				{
					if ( xhr.readyState === XMLHttpRequest.DONE )
					{
						if ( xhr.status === 200 )
						{
							user.value = "";
						}
					}
				});

				xhr.overrideMimeType("text/plain");
				xhr.send("name="+user.value+"&categorie="+categorie+"&genre="+genre+"&club="+club );
			}

			function exist ( user )
			{
				if ( user.value == "" )
				{
					user.style.color = "";
					return;
				}
				let xhr = new XMLHttpRequest();

				xhr.open('POST', '/userExist' );
				xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

				xhr.addEventListener ( 'readystatechange', function ( )
				{
					if ( ( xhr.readyState === XMLHttpRequest.DONE )
						&& ( xhr.status === 200 ) )
					{
						if ( xhr.responseText != "exist" )
						{
							user.style.color = "#afa";
						}
						else
						{
							user.style.color = "#faa";
						}
					}
				});

				xhr.overrideMimeType("text/plain");
				xhr.send("user="+user.value);
			}

			function getClub ( partName, sugestId, masterId )
			{
				if ( partName == "" )
				{
					document.getElementById ( sugestId ).style.display = "none";
					return;
				}
				let xhr = new XMLHttpRequest();

				xhr.open('POST', '/getClub' );
				xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

				xhr.addEventListener ( 'readystatechange', function ( )
				{
					if ( ( xhr.readyState === XMLHttpRequest.DONE )
						&& ( xhr.status === 200 ) )
					{
						displaySugestions ( JSON.parse ( xhr.responseText ), sugestId, masterId );
					}
				});

				xhr.overrideMimeType("text/plain");
				xhr.send("partName="+partName);
			}

			function setValue ( sugestId, masterId, value )
			{
				document.getElementById ( masterId ).value = value;
				document.getElementById ( sugestId ).style.display = "none";
			}

			function displaySugestions ( choices, sugestId, masterId )
			{
				let div = document.getElementById ( sugestId );
				div.style.display = "";
				div.innerHTML = "";

				console.log( "ici" );

				for ( let i = 0; i < choices.length; i++ )
				{
					div.innerHTML += "<div onclick=\"setValue('"+sugestId+"','"+masterId+"',this.innerHTML);\">"+choices[ i ]+"</div>";
				}
			}


		</script>
	</body>
</html>
