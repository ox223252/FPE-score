<!DOCTYPE html>
<html>
	<% include head %>
	<body>
		<% include nav %>
		<section>
			<div>
				<form>
					<select id="genre" onchange="setRank();drawTable();"></select>
					<select id="categorie" onchange="setRank();drawTable();"></select>
					<select id="club" onchange="setRank();drawTable();"></select>
				</form>
				<div id="dataContent">
				</div>
				<div>
					<canvas width="700" height="400" class="chartjs-render-monitor" id="pointGraph"></canvas>
					<canvas width="700" height="700" class="chartjs-render-monitor" id="userGraph"></canvas>
					<ul id="legendGraph" class="smothText">
						<li>moyenne tenté : moyenne des points obtenu pas les personnes ayant tenté cette voie</li>
						<li>moyenne totale : moyenne des points obtenu sur cette voie par toues les personnes ayant participé</li>
					</ul>
				</div>
			</div>
		</section>
		<script src="/socket.io/socket.io.js"></script>
		<script type="text/javascript" src="/js/chartjs.js"></script>
		<script type="text/javascript"> // globals vars
			let socket = io ( );

			let users = <%- JSON.stringify(users) %>;
			let thisUser = undefined;
			let voie = <%- JSON.stringify(voie) %>;
			let score = <%- JSON.stringify(score) %>;

			let g_categorie = document.getElementById ( "categorie" );
			let g_genre = document.getElementById ( "genre" );
			let g_club = document.getElementById ( "club" );

			// voie.length : total
			// voie.length + 1 : rank
			const rankId = voie.length + 1;
			const totalId = voie.length;

			const topId = voie.length + 2;
			const testTopId = voie.length + 3;
			const zoneId = voie.length + 4;
			const testZoneId = voie.length + 5;
			
			var pointConfig = {
				// type: 'bar',
				type: 'line',
				data: {
					labels: [],
					datasets: [
						{
							label: 'points',
							backgroundColor: "rgba(255,0,0,0.1)",
							borderColor: "#f00",
							data: [],
							// fill: true,
							fill: false,
							lineTension: 0
						},
					]
				},
				options: {
					animation: false,
					responsive: true,
					legend: {
						// display: true,
						display: false,
					},
					title: {
						display: false,
					},
					tooltips: {
						mode: 'index',
						intersect: false,
					},
					hover: {
						mode: 'nearest',
						intersect: true
					},
					scales: {
						xAxes: [{
							display: true,
							scaleLabel: {
								display: true,
								labelString: 'users rank'
							}
						}],
						yAxes: [{
							display: true,
							scaleLabel: {
								display: true,
								labelString: 'points',
							},
							ticks: {
								suggestedMin: 0,    // minimum will be 0, unless there is a lower value.
							}
						}]
					}
				}
			};

			var userConfig = {
				type: 'radar',
				data: {
					labels: [ ],
					datasets: [
						{
							backgroundColor: "rgba(255,0,0,0.2)",
							borderColor: "#f00",
							borderWidth: 2,
							data: [ ],
							label: ''
						},
						{
							backgroundColor: "rgba(0,255,255,0.2)",
							borderColor: "rgba(0,255,255,0.2)",
							data: [],
							label: 'moyenne tenté'
						},
						{
							backgroundColor: "rgba(0,0,255,0.4)",
							borderColor: "rgba(0,0,255,0.4)",
							data: [],
							label: 'moyenne total'
						},
						{
							backgroundColor: "rgba(0,0,0,0)",
							borderColor: "rgba(0,0,0,1)",
							borderWidth: 6,
							data: [],
							label: 'max'
						}
					]
				},
				options: {

					maintainAspectRatio: true,
					spanGaps: false,
					elements: {
						line: {
							tension: 0
						}
					},
					hover: {
						mode: 'nearest',
						intersect: true
					},
        			scale: {
						ticks: {
							display:false,
						}
					},
					plugins: {
						filler: {
							propagate: false
						},
						'samples-filler-analyser': {
							target: 'chart-analyser'
						}
					},
				}
			};

			var average = {
				"all" : [],
				"tryed" : [],
				"player" : 0
			}

			let chartjs = {};
		</script>
		<script type="text/javascript"> // graph
			function drawCurves ( id = totalId )
			{
				let userEl = document.getElementById ( "userGraph" );

				pointConfig.data.datasets[ 0 ].data = [];
				pointConfig.data.labels = [];

				// draw evolution of points for selected way
				for ( let i = 0; i < users.length; i++ )
				{
					if ( !score[ users[ i ].name ] )
					{
						continue;
					}

					if ( ( g_categorie.value != "all" ) &&
						( users[ i ].categorie != g_categorie.value ) )
					{
						continue;
					}

					if ( ( g_genre.value != "all" ) &&
						( users[ i ].genre != g_genre.value ) )
					{
						continue;
					}

					if ( ( g_club.value != "all" ) &&
						( users[ i ].club != g_club.value ) )
					{
						continue;
					}

					pointConfig.data.datasets[ 0 ].data.push ( getScore( users[ i ].name, id ) );
					pointConfig.data.labels.push ( getScore( users[ i ].name ) );
				}

				if  ( chartjs[ 'point' ] )
				{
					chartjs[ 'point' ].update ( );
				}
				else
				{
					chartjs[ 'point' ] = new Chart ( document.getElementById ( "pointGraph" ).getContext ( "2d" ), pointConfig );
				}
				
				// draw user slelected graph
				if  ( thisUser &&
					score[ thisUser ] )
				{
					userConfig.data.datasets[ 0 ].label = thisUser;
					for ( let i = 0; i < voie.length; i++ )
					{
						userConfig.data.labels[ i ] = voie[ i ].name;
						if ( voie[ i ].type == 'vitesse' )
						{
							userConfig.data.datasets[ 0 ].data[ i ] =  ( getScore( thisUser, i ) )? voie[ i ].score.time - getScore( thisUser, i ) : 0;
						}
						else
						{
							userConfig.data.datasets[ 0 ].data[ i ] = getScore( thisUser, i ) | 0;
						}
						userConfig.data.datasets[ 1 ].data[ i ] = average.all[ i ] / average.tryed[ i ];
						userConfig.data.datasets[ 2 ].data[ i ] = average.all[ i ] / average.player;

						switch ( voie[ i ].type )
						{
							case 'bloc':
							{
								userConfig.data.datasets[ 3 ].data[ i ] = voie[ i ].score.fin;
								break;
							}
							case 'diff':
							{
								if ( voie[ i ].score.tete )
								{
									userConfig.data.datasets[ 3 ].data[ i ] = voie[ i ].score.tete[ voie[ i ].score.tete.length - 1 ];
								}
								else
								{
									userConfig.data.datasets[ 3 ].data[ i ] = voie[ i ].score.moul[ voie[ i ].score.moul.length - 1 ];
								}
								break;
							}
							case 'vitesse':
							{
								userConfig.data.datasets[ 3 ].data[ i ] = voie[ i ].score.time;
								break;
							}
							case 'slack':
							{
								userConfig.data.datasets[ 3 ].data[ i ] = voie[ i ].score.distance;
								break;
							}
							default:
							{
								break;
							}
						}
					}
					userEl.style.display = "";
					document.getElementById ( "legendGraph" ).style.display = "";

					if  ( chartjs[ 'user' ] )
					{
						chartjs[ 'user' ].update ( );
					}
					else
					{
						chartjs[ 'user' ] = new Chart (  userEl.getContext ( "2d" ), userConfig );
					}
				}
				else
				{
					userEl.style.display = "none";
					document.getElementById ( "legendGraph" ).style.display = "none";
				}
			}
		</script>
		<script type="text/javascript"> // sockets
			socket.on ( 'scores', function ( data )
			{
				setScore ( data.usr, data.voie, data.points );

				uni_calcTotal ( );
				<% if ( ( mode == 'b' ) ||
					( mode == 'a' ) ){ %>
					uni_orderTable ( );
				<% } %>
				setRank ( );
				drawTable ( );
			});

			socket.on ( 'users', function ( usr )
			{
				let i;
				for ( i = 0; i < users.length; i++ )
				{
					if ( users[ i ].name == usr.name )
					{
						break;
					}
				}

				if ( i == users.length )
				{
					users.push ( usr );
				}

				uni_orderTable ( );
			});
		</script>
		<script type="text/javascript"> // utils
			function setScore ( name, id, value, num )
			{
				if ( !name ||
					( id == undefined ) )
				{
					return ( false );
				}

				if ( !score[ name ] )
				{
					score[ name ] = [];
				}

				if ( !score[ name ][ id ] )
				{
					score[ name ][ id ] = [];
				}
				
				if ( num == undefined )
				{
					score[ name ][ id ].push ( value );
				}
				else
				{
					score[ name ][ id ][ num ] = value;
				}
			}

			function getScore ( name, id = rankId )
			{
				if ( !name ||
					( id == undefined ) ||
					!score[ name ] ||
					!score[ name ][ id ] )
				{
					return ( false );
				}
				
				let max = score[ name ][ id ][ 0 ];
				for ( let i = 1; i < score[ name ][ id ].length; i++ )
				{
					
					if ( score[ name ][ id ][ i ] > max )
					{
						max = score[ name ][ id ][ i ];
					}
				}
				return ( max );
			}

			function getNbTop ( name )
			{
				if ( !name ||
					!score[ name ] )
				{
					return ( 0 );
				}

				let top = 0;
				for ( let i = 0; i < voie.length; i++ )
				{
					if ( !score[ name ][ i ] )
					{
						continue;
					}

					for ( let j = 0; j < score[ name ][ i ].length; j++ )
					{
						if ( score[ name ][ i ][ j ] == 'top' )
						{
							top++;
							break; // si un top à été compté dans une voie on passe à la suivante
						}
					}
				}
				return ( top );
			}

			function getNbEssaisTop ( name )
			{
				if ( !name ||
					!score[ name ] )
				{
					return ( 0 );
				}

				let essai = 0;
				for ( let i = 0; i < voie.length; i++ )
				{
					if ( !score[ name ][ i ] )
					{
						continue;
					}

					let tmp = 0;
					for ( let j = 0; j < score[ name ][ i ].length; j++ )
					{
						tmp++;
						if ( score[ name ][ i ][ j ] == 'top' )
						{
							essai += tmp;
							break; // si un top à été compté dans une voie on passe à la suivante
						}
					}
				}
				return ( essai );
			}

			function getNbZone ( name )
			{
				if ( !name ||
					!score[ name ] )
				{
					return ( 0 );
				}

				let zone = 0;
				for ( let i = 0; i < voie.length; i++ )
				{
					if ( !score[ name ][ i ] )
					{
						continue;
					}
					for ( let j = 0; j < score[ name ][ i ].length; j++ )
					{
						if ( ( score[ name ][ i ][ j ] == 'top' ) ||
							( score[ name ][ i ][ j ] == 'zone' ) )
						{
							zone++;
							break;
						}
					}
				}
				return ( zone );
			}

			function getNbEssaisZone ( name )
			{
				if ( !name ||
					!score[ name ] )
				{
					return ( 0 );
				}

				let essai = 0;
				for ( let i = 0; i < voie.length; i++ )
				{
					if ( !score[ name ][ i ] )
					{
						continue;
					}
					
					let tmp = 0;
					for ( let j = 0; j < score[ name ][ i ].length; j++ )
					{
						tmp++;
						if ( ( score[ name ][ i ][ j ] == 'top' ) ||
							( score[ name ][ i ][ j ] == 'zone' ) )
						{
							essai += tmp;
							break;
						}
					}
				}
				return ( essai );
			}

			function getnbTests ( name, id )
			{
				if ( !name ||
					( id == undefined ) ||
					!score[ name ] ||
					!score[ name ][ id ] )
				{
					return ( false );
				}

				return ( score[ name ][ id ].length );
			}
		</script>
		<script type="text/javascript">

			function uni_calcTotal ( id = totalId )
			{ // get data to calculate average and globals metrics
				// init average struct
				for ( let i = 0; i < voie.length; i++ )
				{
					average.all[ i ] = 0;
					average.tryed[ i ] = 0;
					average.player = 0;
				}

				<% if ( mode == 'a' ) { %>
					autre_calcTotal ( id );
				<% } else if ( mode == 'b' ) { %>
					bloc_calcTotal ( id );
				<% } else if ( mode == 'd' ) { %>
					diff_calcTotal ( id );
				<% } %>
			}

			<% if ( mode == 'a' ) { /* autre calc total */%>
				function autre_calcTotal ( )
				{
					for ( let i = 0; i < users.length; i++ )
					{
						if ( !score[ users[ i ].name ] )
						{
							continue;
						}
						let somme = 0;

						for ( let j = 0; j < voie.length; j++ )
						{
							if ( ( voie[ j ].type == 'vitesse' ) &&
								getScore( users[ i ].name, j ) )
							{
								let tmp = ( voie[ j ].score.time - getScore( users[ i ].name, j ) );
								somme += ( tmp < 0 )? 0: tmp;
								
								average.all[ j ] += tmp; // totalise points for all users
								if ( getScore( users[ i ].name, j ) )
								{
									average.tryed[ j ]++;
								}
							}
							else
							{
								somme += getScore( users[ i ].name, j ) | 0;
								average.all[ j ] += getScore( users[ i ].name, j ) | 0;

								if ( getScore( users[ i ].name, j ) )
								{
									average.tryed[ j ]++;
								}
							}
						}

						if ( score[ users[ i ].name ] )
						{
							average.player++;
						}

						setScore( users[ i ].name, totalId, somme );
					}
				}
			<% } %>
			<% if ( mode == 'b' ) { /* bloc calc total */%>
				function bloc_calcTotal ( )
				{
					let l = voie.length.toString( ).length;
					divider = 1;

					while ( l-- )
					{
						divider *= 10;
					}

					for ( let i = 0; i < users.length; i++ )
					{
						if ( !score[ users[ i ].name ] )
						{
							continue;
						}

						let top = getNbTop ( users[ i ].name );
						let nbTestTop = getNbEssaisTop ( users[ i ].name );
						let zone = getNbZone ( users[ i ].name );
						let nbTestZone = getNbEssaisZone ( users[ i ].name );

						setScore( users[ i ].name, topId, top );
						setScore( users[ i ].name, testTopId, nbTestTop );

						setScore( users[ i ].name, zoneId, zone );
						setScore( users[ i ].name, testZoneId, nbTestZone );

						for ( let j = 0; j < voie.length; j++ )
						{
							average.tryed[ j ] += getnbTests ( users[ i ].name, j );
							average.all[ j ] += top;
						}

						if ( score[ users[ i ].name ] )
						{
							average.player++;
						}

						let str = top+'.'+nbTestTop+'.'+zone+'.'+nbTestZone;

						setScore( users[ i ].name, totalId, str, 0 );
					}
				}
			<% } %>
			<% if ( mode == 'd' ) { /* diff calc total */%>
				function diff_calcTotal ( )
				{

					let qRank = {};

					for ( track = 0; track < voie.length; track++ )
					{
						uni_orderTable ( track );
						setRank ( track );

						for ( i = 0; i < users.length; i++ )
						{
							let tmp = 0;
							if ( !score[ users[ i ].name ] )
							{
								continue;
							}
							else if ( !score[ users[ i ].name ][ track ] )
							{
								tmp = users.length;
							}
							else
							{
								tmp = score[ users[ i ].name ][ rankId ][ 0 ];
							}

							if ( !qRank[ users[ i ].name ] )
							{
								qRank[ users[ i ].name ] = tmp * tmp;
							}
							else
							{
								qRank[ users[ i ].name ] += tmp * tmp;
							}
						}
					}

					for ( i = 0; i < users.length; i++ )
					{
						if ( !score[ users[ i ].name ] )
						{
							continue;
						}

						setScore( users[ i ].name, totalId, Math.sqrt ( qRank[ users[ i ].name ] ), 0 );
					}
				}
			<% } %>

			function dopDownUser ( id = totalId )
			{ // put user without score at the end
				let somethingChange = false;
				do
				{
					somethingChange = false;
					for ( let i = 0; i < users.length - 1; i++ )
					{
						if ( !getScore( users[ i ].name, id ) && 
							getScore( users[ i + 1 ].name, id ) )
						{
							let tmp = users[ i ];
							users[ i ] = users[ i + 1 ];
							users[ i + 1 ] = tmp;
							somethingChange = true;
						}
					}
				}
				while ( somethingChange );
			}

			function uni_orderTable ( id = totalId )
			{
				dopDownUser ( id );

				<% if ( mode == 'a' ) { %>
					autre_orderTable ( id );
				<% } else if ( mode == 'b' ) { %>
					bloc_orderTable ( id );
				<% } else if ( mode == 'd' ) { %>
					diff_orderTable ( id );
				<% } %>
			}
			
			<% if ( mode == 'a' ) { /* autre order table */%>
				function autre_orderTable ( id = totalId )
				{
					dopDownUser ( id );

					// order users
					for ( let i = 0; i < users.length - 1; i++ )
					{
						if ( !score[ users[ i ].name ] )
						{
							break;
						}

						for ( let j = i+1; j < users.length; j++ )
						{
							if ( !getScore( users[ j ].name, id ) )
							{
								break;
							}

							if ( ( id < voie.length ) &&
								( voie[ id ].type == 'vitesse' ) )
							{ // order speed test (less is better)
								if ( parseFloat( getScore( users[ i ].name, id ) ) > parseFloat( getScore( users[ j ].name, id ) ) )
								{
									let tmp = users[ i ];
									users[ i ] = users[ j ];
									users[ j ] = tmp;
								}
							}
							else if ( !getScore( users[ i ].name, id ) || 
								getScore( users[ j ].name, id ) &&
								( getScore( users[ i ].name, id ) < getScore( users[ j ].name, id ) ) )
							{
								let tmp = users[ i ];
								users[ i ] = users[ j ];
								users[ j ] = tmp;
							}
						}
					}
				}
			<% } %>
			<% if ( mode == 'b' ) { /* bloc order table */%>
				function bloc_orderTable ( id = totalId )
				{

					// order users
					let change = false;
					do
					{
						change = false;
						for ( let i = 0; i < users.length - 1; i++ )
						{
							if ( !score[ users[ i ].name ] )
							{
								break;
							}

							if ( ( getNbTop ( users[ i ].name ) < getNbTop ( users[ i + 1 ].name ) ) ||
								( 
									( getNbTop ( users[ i ].name ) == getNbTop ( users[ i + 1 ].name ) ) &&
									( getNbEssaisTop ( users[ i ].name ) > getNbEssaisTop ( users[ i + 1 ].name ) ) 
								) ||
								(
									( getNbTop ( users[ i ].name ) == getNbTop ( users[ i + 1 ].name ) ) &&
									( getNbEssaisTop ( users[ i ].name ) == getNbEssaisTop ( users[ i + 1 ].name ) ) &&
									( getNbZone ( users[ i ].name ) < getNbZone ( users[ i + 1 ].name ) )
								) ||
								(
									( getNbTop ( users[ i ].name ) == getNbTop ( users[ i + 1 ].name ) ) &&
									( getNbEssaisTop ( users[ i ].name ) == getNbEssaisTop ( users[ i + 1 ].name ) ) &&
									( getNbZone ( users[ i ].name ) == getNbZone ( users[ i + 1 ].name ) ) &&
									( getNbEssaisZone ( users[ i ].name ) < getNbEssaisZone ( users[ i + 1 ].name ) )
								) )
							{
								change = true;

								let tmp = users[ i ];
								users[ i ] = users[ i + 1 ];
								users[ i + 1 ] = tmp;
							}
						}
					}
					while ( change );
				}
			<% } %>
			<% if ( mode == 'd' ) { /* diff order table */%>
				function diff_orderTable ( id = totalId, signe = 1 )
				{
					// order users
					let change = false;
					do
					{
						change = false;
						for ( let i = 0; i < users.length - 1; i++ )
						{
							if ( !score[ users[ i ].name ] )
							{
								break;
							}

							for ( let j = i+1; j < users.length; j++ )
							{
								console.log( id + " | " + getScore( users[ i ].name, id ) + " : " + signe + " : " + getScore( users[ j ].name, id ) )
								if ( !getScore( users[ j ].name, id ) )
								{
									break;
								}

								if ( !getScore( users[ i ].name, id ) || 
									( signe < 0 ) &&
									getScore( users[ j ].name, id ) &&
									( getScore( users[ i ].name, id ) < getScore( users[ j ].name, id ) ) ||
									( signe > 0 ) &&
									getScore( users[ j ].name, id ) &&
									( getScore( users[ i ].name, id ) > getScore( users[ j ].name, id ) ) )
								{
									let tmp = users[ i ];
									users[ i ] = users[ j ];
									users[ j ] = tmp;
								
									change = true;
								}
							}
						}
					}
					while ( change );
				}
			<% } %>


			function setRank ( id = totalId )
			{
				// set ranks
				let lastPoint = 0;
				let lastRank = 0;

				for ( let i = 0; i < users.length - 1; i++ )
				{
					if ( !score[ users[ i ].name ] )
					{
						break;
					}

					if ( ( g_categorie.value != "all" ) &&
						( users[ i ].categorie != g_categorie.value ) )
					{
						continue;
					}

					if ( ( g_genre.value != "all" ) &&
						( users[ i ].genre != g_genre.value ) )
					{
						continue;
					}

					if ( ( g_club.value != "all" ) &&
						( users[ i ].club != g_club.value ) )
					{
						continue;
					}

					if ( lastPoint != getScore( users[ i ].name, id ) )
					{
						lastPoint = getScore( users[ i ].name, id );
						lastRank++;
					}

					setScore( users[ i ].name, rankId, lastRank, 0 );
				}
			}

			function drawTable ( id = totalId )
			{
				let str = "<div  id=\"results\"><table><tr><td onclick=\"updateUser();\"></td><td>h/f</td><td>cat.</td>";

				// header
				for ( let j = 0; j < voie.length; j++ )
				{
					str += '<td onclick="uni_orderTable('+j+');drawTable('+j+');">'+voie[ j ].name+'</td>';
				}
				str += '<td onclick="uni_orderTable('+rankId+');drawTable();">Total</td><td onclick="uni_orderTable('+rankId+');drawTable();">rank</td>';

				for ( let i = 0; i < users.length; i++ )
				{
					if ( ( g_categorie.value != "all" ) &&
						( users[ i ].categorie != g_categorie.value ) )
					{
						continue;
					}

					if ( ( g_genre.value != "all" ) &&
						( users[ i ].genre != g_genre.value ) )
					{
						continue;
					}

					if ( ( g_club.value != "all" ) &&
						( users[ i ].club != g_club.value ) )
					{
						continue;
					}

					// nom
					if ( users[ i ].name == thisUser )
					{
						str += '<tr class="hightlight">';
					}
					else
					{
						str += '<tr>';
					}

					str += '<td onclick="updateUser(this.innerHTML);">'+users[ i ].name+'</td>';
					str += '<td>'+((users[ i ].genre=="homme")?"M":"F")+'</td>';
					str += '<td>'+users[ i ].categorie+'</td>';

					if ( !score[ users[ i ].name ] )
					{
						str += '</tr>';
						continue;
					}

					// score
					for ( let j = 0; j < voie.length + 2; j++ )
					{
						if ( j == id )
						{
							str += '<td class="hightlight">';
						}
						else
						{
							str += '<td>';
						}

						if ( getScore( users[ i ].name, j ) )
						{
							str += getScore( users[ i ].name, j );
						}

						str+='</td>';
					}
					str += '</tr>';
				}
				document.getElementById ( "dataContent" ).innerHTML = str+'</table></div>';
				drawCurves ( id );
			}

			function updateUser ( user )
			{
				thisUser = user;
				drawTable ( );
			}

			function updateSelector ( )
			{
				let genre = [];
				let categorie = [];
				let club = [];

				for ( let i = 0; i < users.length; i++ )
				{
					if ( !categorie.includes( users[ i ].categorie ) )
					{
						categorie.push ( users[ i ].categorie );
					}

					if ( !genre.includes( users[ i ].genre ) )
					{
						genre.push ( users[ i ].genre );
					}

					if ( !club.includes( users[ i ].club ) )
					{
						club.push ( users[ i ].club );
					}
				}

				
				while ( g_genre.options.length )
				{
					g_genre.options.remove ( 0 );
				}
				g_genre.options.add ( new Option ( "genre", 0 ) );
				g_genre.options[ 0 ].value = "all";
				for ( let i = 0; i < genre.length; i++ )
				{
					g_genre.options.add ( new Option ( genre[ i ], i + 1 ) );
					g_genre.options[ i + 1 ].value = genre[ i ];
				}


				while ( g_categorie.options.length )
				{
					g_categorie.options.remove ( 0 );
				}
				g_categorie.options.add ( new Option ( "age", 0 ) );
				g_categorie.options[ 0 ].value = "all";
				for ( let i = 0; i < categorie.length; i++ )
				{
					g_categorie.options.add ( new Option ( categorie[ i ], i + 1 ) );
					g_categorie.options[ i + 1 ].value = categorie[ i ];
				}


				while ( g_club.options.length )
				{
					g_club.options.remove ( 0 );
				}
				g_club.options.add ( new Option ( "Club", 0 ) );
				g_club.options[ 0 ].value = "all";
				for ( let i = 0; i < club.length; i++ )
				{
					g_club.options.add ( new Option ( club[ i ], i + 1 ) );
					g_club.options[ i + 1 ].value = club[ i ];
				}
			}

			updateSelector ( );
			uni_calcTotal ( );
			<% if ( ( mode == 'b' ) ||
				( mode == 'a' ) ){ %>
				uni_orderTable ( );
			<% } %>
			setRank ( );
			drawTable ( );
		</script>
	</body>
</html>
