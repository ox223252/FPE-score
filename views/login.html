<!DOCTYPE html>
<html>
	<% include head %>
	<body>
		<nav>
			<a href="/">Scores</a>
		</nav>
		<section>
			<div>
				<div>
					<input id="user" type="text" placeholder="user" onchange="login();"/>
				</div>
				<div>
					<input id="password" type="password" placeholder="password" onchange="login();"/>
				</div>
				<div>
					<a href="/">back</a>
				</div>
				<div>
					<p id="serverMsg"></p>
				</div>
			</div>
		</section>
		<script type="text/javascript" src="/js/cryptico.min.js"></script>
		<script type="text/javascript" src="/js/sha512.min.js"></script>
		<script type="text/javascript"> // password
			let pubKey = "<%- pubKey %>";
			function login ( )
			{

				let user = document.getElementById( 'user' ).value;
				let password = document.getElementById( 'password' ).value;

				if ( ( user == "" ) ||
					( password == "" ) )
				{
					console.log( "exit" );
					return;
				}

				let xhr = new XMLHttpRequest();

				xhr.open('POST', '/login' );
				xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

				xhr.addEventListener ( 'readystatechange', function ( )
				{
					if ( xhr.readyState === XMLHttpRequest.DONE )
					{
						if ( xhr.status === 200 )
						{
							document.getElementById( 'serverMsg' ).innerHTML = "<span style=\"color:green;\">Ok</span>";
							window.location.href = "/";
						}
						else if ( xhr.status === 401 )
						{
							document.getElementById( 'serverMsg' ).innerHTML = "<span style=\"color:red;\">"+xhr.responseText+"</span>";
						}
						else if ( xhr.status === 403 )
						{
							if ( 5 - parseInt ( xhr.responseText ) )
							{
								document.getElementById( 'serverMsg' ).innerHTML = "<span style=\"color:orange;\">pass invalid, it remain only <span style='color:red'>"+( 5 - parseInt ( xhr.responseText ) )+"</span> try</span>";
							}
							else
							{
								document.getElementById( 'serverMsg' ).innerHTML = "<span style=\"color:red;\">no more try available</span>";
							}
						}
						else
						{
							document.getElementById( 'serverMsg' ).innerHTML = "<span style=\"color:#f55;\">" + xhr.responseText + "</span>";
						}
					}
				});

				// encrypt password to prevent clear storage on server
				// you prevent the admin read it in clear mode
				let tmp = {
					"user":user,
					"password":sha512(password)
				};

				let enc = cryptico.encrypt ( JSON.stringify ( tmp ), pubKey );
				console.log( enc.cipher );

				xhr.overrideMimeType ( "text/plain" );
				// need encodeURIComponent() for plus (+) signs
				xhr.send ( "data="+encodeURIComponent ( enc.cipher ) );
			}
		</script>
	</body>
</html>
