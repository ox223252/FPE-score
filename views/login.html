<!DOCTYPE html>
<html>
	<%- include("partials/head.html") -%>
	<body>
		<%- include("partials/nav.html") -%>
		<section>
			<div>
				<div>
					<input id="user" type="text" placeholder="user"/>
				</div>
				<div>
					<input id="password" type="password" placeholder="password"/>
				</div>
				<div>
					<button id="valid">Connexion <span id="count"></span></button>
				</div>
				<div>
					<p id="serverMsg"></p>
				</div>
			</div>
		</section>
		<script type="text/javascript"  nonce="<%- locals.nonce %>"> // password

			let domEls = {
				user: document.getElementById ( "user" ),
				password: document.getElementById ( "password" ),
				button: document.getElementById ( "valid" ),
				count: document.getElementById ( "count" )
			}

			function log ( params )
			{
				return fetch ( "/ajax/login", {
						method: "POST",
						body: JSON.stringify ( params ),
						headers: {"Content-Type": "application/json"},
					})
					.then ( async r=>{
						if ( r.ok )
						{
							return r.json ( );
						}
						else
						{
							throw {status:r.status,json:await r.json()};
						}
					})
					.then ( r=>{
						if ( r.token )
						{
							localStorage.setItem ( "token", r.token );
						}

						return new Promise ( (ok,ko)=>{
							setTimeout ( ok, 1000, r );
						})
					})
					.then ( r=>{
						window.location.pathname = r.target;
					})
					.catch ( console.log )
			}

			window.onload = ()=>{
				let token = localStorage.getItem ( "token" );

				return log ( {token:token} );
			}

			domEls.button.onclick = ()=>{
				return log ( {
						user: domEls.user.value,
						password: domEls.password.value,
					} )
			}
		</script>
	</body>
</html>
