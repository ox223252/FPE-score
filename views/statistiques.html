<!DOCTYPE html>
<html>
	<% include head %>
	<body>
		<% include nav %>
		<section>
			<div class="graphPaper">
				<canvas width="700" height="700" class="chartjs-render-monitor" id="graph_average"></canvas>
				<span class="smothText"><label for="avreage_percent"> affichage en %</label><input type="checkbox" id="avreage_percent" onchange="drawCurves ( );"></span>
			</div>
			<div class="graphPaper">
				<canvas width="700" height="700" class="chartjs-render-monitor" id="graph_nbTry"></canvas>
			</div>
			<div class="graphPaper" id="clubsGrpahs">
			</div>
		</section>
		<script type="text/javascript" src="/js/chartjs.js"></script>
		<script src="/socket.io/socket.io.js"></script>
		<script type="text/javascript"> // globals vars
			let socket = io ( );
			let users = <%- JSON.stringify(users) %>;
			let voie = <%- JSON.stringify(voie) %>;
			let score = <%- JSON.stringify(score) %>;

			var config = {
				"try" : {
					type: 'bar',
					// type: 'line',
					data: {
						labels: [ ],
						datasets: [
							{
								backgroundColor: "rgba(255,0,0,0.7)",
								borderColor: "rgba(255,0,0,0.7)",
								data: [ ],
								label: 'nb reussite'
							},
							{
								backgroundColor: "rgba(255,255,0,0.7)",
								borderColor: "rgba(255,255,0,0.7)",
								data: [ ],
								label: 'nb joueur ayant tenté'
							},
							{
								backgroundColor: "rgba(0,255,0,0.7)",
								borderColor: "rgba(0,255,0,0.7)",
								data: [],
								label: 'nb tentatives'
							},
							{
								backgroundColor: "rgba(0,0,255,0.7)",
								borderColor: "rgba(0,0,255,0.7)",
								data: [],
								label: 'nb participants',
								fill:false,
								type: 'line'
							}
						]
					},
					options: {
						animation: false,
						responsive: true,
						title: {
							display: true,
							text: "Tentatives"
						},
						tooltips: {
							mode: 'index',
							intersect: false,
						},
						hover: {
							mode: 'nearest',
							intersect: true
						},
						scales: {
							xAxes: [{
								display: true,
								scaleLabel: {
									display: true,
									labelString: 'users rank'
								}
							}],
							yAxes: [{
								display: true,
								scaleLabel: {
									display: true,
									labelString: 'points',
								},
								ticks: {
									suggestedMin: 0,    // minimum will be 0, unless there is a lower value.
								}
							}]
						}
					}
				},
				'average' : {
					type: 'bar',
					data: {
						labels: [ ],
						datasets: [
							{
								backgroundColor: "rgba(255,0,0,0.7)",
								borderColor: "rgba(255,0,0,0.7)",
								data: [ ],
								label: "moyenne totale"
							},
							{
								backgroundColor: "rgba(255,255,0,0.7)",
								borderColor: "rgba(255,255,0,0.7)",
								data: [ ],
								label: "moyenne des gens l'ayant tenté"
							},
							{
								backgroundColor: "rgba(0,0,255,0.7)",
								borderColor: "rgba(0,0,255,0.7)",
								data: [ ],
								label: "maximum"
							}
						]
					},
					options: {
						animation: false,
						responsive: true,
						title: {
							display: true,
							text: "Résultats"
						},
						tooltips: {
							mode: 'index',
							intersect: false,
						},
						hover: {
							mode: 'nearest',
							intersect: true
						},
						scales: {
							xAxes: [{
								display: true,
								scaleLabel: {
									display: true,
									labelString: 'users rank'
								}
							}],
							yAxes: [{
								display: true,
								scaleLabel: {
									display: true,
									labelString: 'points',
								},
								ticks: {
									suggestedMin: 0,    // minimum will be 0, unless there is a lower value.
								}
							}]
						}
					}
				},
			};

			let average = [];
			let player = 0;
			let chartjs = {};
			let clubList = [];
			let clubs = {};
		</script>
		<script type="text/javascript"> // sockets
			socket.on ( 'scores', function ( data )
			{
				setScore ( data.usr, data.voie, data.points );

				calcAverage ( );
			});

			socket.on ( 'users', function ( usr )
			{
				let i;
				for ( i = 0; i < users.length; i++ )
				{
					if ( users[ i ].name == usr.name )
					{
						break;
					}
				}

				if ( i == users.length )
				{
					users.push ( usr );
				}
			});
		</script>
		<script type="text/javascript"> // utils
			function clone ( obj )
			{
				if ( ( null == obj ) ||
					( "object" != typeof obj ) )
				{
					return ( obj );
				}

				let copy = obj.constructor ( );
				for ( var attr in obj )
				{
					if ( obj.hasOwnProperty ( attr ) )
					{
						copy[attr] = obj[attr];
					}
				}
				return ( copy );
			}

			function setScore ( name, id, value )
			{
				if ( !name ||
					( id == undefined ) )
				{
					return ( false );
				}

				if ( !score[ name ] )
				{
					score[ name ] = [];
				}

				if ( !score[ name ][ id ] )
				{
					score[ name ][ id ] = [];
				}
				
				score[ name ][ id ].push ( value );
			}
			function getScore ( name, id )
			{
				if ( !name ||
					( id == undefined ) ||
					!score[ name ] ||
					!score[ name ][ id ] )
				{
					return ( false );
				}
				
				let max = score[ name ][ id ][ 0 ];
				for ( let i = 1; i < score[ name ][ id ].length; i++ )
				{
					if ( parseFloat( score[ name ][ id ][ i ] ) > parseFloat( max ) )
					{
						max = score[ name ][ id ][ i ];
					}
				}
				return ( max );
			}
			function getNbTests ( name, id )
			{
				if ( !name ||
					( id == undefined ) ||
					!score[ name ] ||
					!score[ name ][ id ] )
				{
					return ( false );
				}

				return ( score[ name ][ id ].length );
			}
		</script>
		<script type="text/javascript"> // graph
			function drawCurves ( )
			{
				function graph_average ( )
				{
					let ctx = document.getElementById ( "graph_average" ).getContext ( "2d" );
	
					let pourcent = document.getElementById ( "avreage_percent" ).checked;
	
					config[ 'average' ].data.labels = [];
					config[ 'average' ].data.datasets[ 0 ].data = [];
					config[ 'average' ].data.datasets[ 1 ].data = [];
					config[ 'average' ].data.datasets[ 2 ].data = [];
	
					// draw evolution of points for selected way
					for ( let i = 0; i < average.length; i++ )
					{
						if ( pourcent )
						{
								config[ 'average' ].options.scales.yAxes[0].scaleLabel.labelString = "% max de points";
							config[ 'average' ].data.labels.push ( average[ i ].name + ' %' );
								config[ 'average' ].data.datasets[ 0 ].data.push ( ( average[ i ].total / player / average[ i ].max * 100 ) | 0 );
								config[ 'average' ].data.datasets[ 1 ].data.push ( ( average[ i ].total / average[ i ].nbPlayerTestIt / average[ i ].max * 100 ) | 0 );
						}
						else
						{
							config[ 'average' ].options.scales.yAxes[0].scaleLabel.labelString = "points";
							config[ 'average' ].data.labels.push ( average[ i ].name );
								config[ 'average' ].data.datasets[ 0 ].data.push ( ( average[ i ].total / player ) | 0 );
							config[ 'average' ].data.datasets[ 1 ].data.push ( ( average[ i ].total / average[ i ].nbPlayerTestIt ) | 0 );
							config[ 'average' ].data.datasets[ 2 ].data.push ( ( average[ i ].max ) | 0 );
						}
					}
	
					if  ( chartjs[ 'average' ] )
					{
						chartjs[ 'average' ].update ( );
					}
					else
					{
						chartjs[ 'average' ] = new Chart ( ctx, config[ 'average' ] );
					}
				}

				function graph_try ( )
				{
					let ctx = document.getElementById ( "graph_nbTry" ).getContext ( "2d" );
	
					config[ 'try' ].data.labels = [];
					config[ 'try' ].data.datasets[ 0 ].data = [];
					config[ 'try' ].data.datasets[ 1 ].data = [];
					config[ 'try' ].data.datasets[ 2 ].data = [];
					config[ 'try' ].data.datasets[ 3 ].data = [];
	
					// draw evolution of points for selected way
					for ( let i = 0; i < average.length; i++ )
					{
						config[ 'try' ].data.labels.push ( average[ i ].name );
						config[ 'try' ].data.datasets[ 0 ].data.push ( average[ i ].success );
						config[ 'try' ].data.datasets[ 1 ].data.push ( average[ i ].nbPlayerTestIt );
						config[ 'try' ].data.datasets[ 2 ].data.push ( average[ i ].nbTry );
						config[ 'try' ].data.datasets[ 3 ].data.push ( player );
					}
	
					if ( chartjs[ 'try' ] )
					{
						chartjs[ 'try' ].update ( );
					}
					else
					{
						chartjs[ 'try' ] = new Chart ( ctx, config[ 'try' ] );
					}
				}

				function graph_club ( )
				{
					getClubsStats ( );

					let div = document.getElementById ( 'clubsGrpahs' );
					div.innerHTML = "";

					for ( let i = 0; i < clubList.length; i++ )
					{
						div.innerHTML += '<canvas width="700" height="700" class="chartjs-render-monitor" id="graph_club_'+clubList[ i ]+'"></canvas>';
					}

					for ( let i = 0; i < clubList.length; i++ )
					{
						let ctx = document.getElementById ( 'graph_club_' + clubList[ i ] ).getContext ( "2d" );

						if ( !chartjs[ 'club_' + clubList[ i ] ] )
						{
							config[ 'club_' + clubList[ i ] ] = {
								type: 'bar',
								data: {
									labels: [ ],
									datasets: [	]
								},
								options: {
									animation: false,
									responsive: true,
									title: {
										display: false,
									},
									tooltips: {
										mode: 'index',
										intersect: false,
									},
									hover: {
										mode: 'nearest',
										intersect: true
									},
									scales: {
										xAxes: [{
											display: true,
											scaleLabel: {
												display: false,
											}
										}],
										yAxes: [{
											display: true,
											scaleLabel: {
												display: true,
												labelString: 'nb participants',
											},
											ticks: {
												suggestedMin: 0,    // minimum will be 0, unless there is a lower value.
											}
										}]
									}
								}
							}
						}

						config[ 'club_' + clubList[ i ] ].data.labels = [ clubList[ i ] ];

						if ( clubs[ clubList[ i ] ].microbe )
						{
							config[ 'club_' + clubList[ i ] ].data.datasets.push ({ backgroundColor: "rgba(255,0,0,0.7)", borderColor: "rgba(255,0,0,0.7)", data: [ clubs[ clubList[ i ] ].microbe ], label: "microbe" });
						}
						if ( clubs[ clubList[ i ] ].poussin )
						{
							config[ 'club_' + clubList[ i ] ].data.datasets.push ({ backgroundColor: "rgba(255,30,0,0.7)", borderColor: "rgba(255,30,0,0.7)", data: [ clubs[ clubList[ i ] ].poussin ], label: "poussin" });
						}
						if ( clubs[ clubList[ i ] ].bejamin )
						{
							config[ 'club_' + clubList[ i ] ].data.datasets.push ({ backgroundColor: "rgba(255,60,0,0.7)", borderColor: "rgba(255,60,0,0.7)", data: [ clubs[ clubList[ i ] ].bejamin ], label: "bejamin" });
						}
						if ( clubs[ clubList[ i ] ].minime )
						{
							config[ 'club_' + clubList[ i ] ].data.datasets.push ({ backgroundColor: "rgba(255,90,0,0.7)", borderColor: "rgba(255,90,0,0.7)", data: [ clubs[ clubList[ i ] ].minime ], label: "minime" });
						}
						if ( clubs[ clubList[ i ] ].cadet )
						{
							config[ 'club_' + clubList[ i ] ].data.datasets.push ({ backgroundColor: "rgba(255,120,0,0.7)", borderColor: "rgba(255,120,0,0.7)", data: [ clubs[ clubList[ i ] ].cadet ], label: "cadet" });
						}
						if ( clubs[ clubList[ i ] ].senior )
						{
							config[ 'club_' + clubList[ i ] ].data.datasets.push ({ backgroundColor: "rgba(255,150,0,0.7)", borderColor: "rgba(255,150,0,0.7)", data: [ clubs[ clubList[ i ] ].senior ], label: "senior" });
						}
						if ( clubs[ clubList[ i ] ].veterant )
						{
							config[ 'club_' + clubList[ i ] ].data.datasets.push ({ backgroundColor: "rgba(255,180,0,0.7)", borderColor: "rgba(255,180,0,0.7)", data: [ clubs[ clubList[ i ] ].veterant ], label: "veterant" });
						}


						if ( clubs[ clubList[ i ] ].homme )
						{
							config[ 'club_' + clubList[ i ] ].data.datasets.push ({ backgroundColor: "rgba(255,0,255,0.7)", borderColor: "rgba(255,0,255,0.7)", data: [ clubs[ clubList[ i ] ].homme ], label: "homme" });
						}
						if ( clubs[ clubList[ i ] ].femme )
						{
							config[ 'club_' + clubList[ i ] ].data.datasets.push ({ backgroundColor: "rgba(255,0,150,0.7)", borderColor: "rgba(255,0,150,0.7)", data: [ clubs[ clubList[ i ] ].femme ], label: "femme" });
						}


						if ( clubs[ clubList[ i ] ].nbTry )
						{
							config[ 'club_' + clubList[ i ] ].data.datasets.push ({ backgroundColor: "rgba(0,255,0,0.7)", borderColor: "rgba(0,255,0,0.7)", data: [ clubs[ clubList[ i ] ].nbTry ], label: "nombre d'essais" });
						}
						if ( clubs[ clubList[ i ] ].win )
						{
							config[ 'club_' + clubList[ i ] ].data.datasets.push ({ backgroundColor: "rgba(150,250,0,0.7)", borderColor: "rgba(150,250,0,0.7)", data: [ clubs[ clubList[ i ] ].win ], label: "voies finies" });
						}
						

						if ( chartjs[ 'club_' + clubList[ i ] ] )
						{
							chartjs[ 'club_' + clubList[ i ] ].update ( );
						}
						else
						{
							chartjs[ 'club_' + clubList[ i ] ] = new Chart ( ctx, config[ 'club_' + clubList[ i ] ] );
						}
					}
				}

				graph_average ( );
				graph_try ( );
				graph_club ( );
			}

			function getClubsStats ( )
			{
				clubList = [];
				clubList.push ( 'tous' );

				for ( let i = 0; i < users.length; i++ )
				{
					console.log( score[ users[ i ].name ] );
					if ( !score[ users[ i ].name ])
					{
						continue;
					}

					if ( !clubList.includes ( users[ i ].club ) )
					{
						clubList.push ( users[ i ].club );
						clubs[ users[ i ].club ] = {};
						clubs[ users[ i ].club ].microbe = 0;
						clubs[ users[ i ].club ].poussin = 0;
						clubs[ users[ i ].club ].bejamin = 0;
						clubs[ users[ i ].club ].minime = 0;
						clubs[ users[ i ].club ].cadet = 0;
						clubs[ users[ i ].club ].senior = 0;
						clubs[ users[ i ].club ].veterant = 0;
						clubs[ users[ i ].club ].homme = 0;
						clubs[ users[ i ].club ].femme = 0;
						clubs[ users[ i ].club ].nbTry = 0;
						clubs[ users[ i ].club ].win = 0;
					}

					clubs[ users[ i ].club ][ users[ i ].categorie ]++;
					clubs[ users[ i ].club ][ users[ i ].genre ]++;

					for ( let j = 0; j < voie.length; j++ )
					{
						clubs[ users[ i ].club ].nbTry += getNbTests ( users[ i ].name, j ) | 0;

						if ( average[ i ].max == getScore ( users[ i ].name, j ) | 0 )
						{
							clubs[ users[ i ].club ].win++;;
						}
					}
					console.log( clubs[ users[ i ].club ] );
				}

				clubs[ 'tous' ] = {};
				clubs[ 'tous' ].microbe = 0;
				clubs[ 'tous' ].poussin = 0;
				clubs[ 'tous' ].bejamin = 0;
				clubs[ 'tous' ].minime = 0;
				clubs[ 'tous' ].cadet = 0;
				clubs[ 'tous' ].senior = 0;
				clubs[ 'tous' ].veterant = 0;
				clubs[ 'tous' ].homme = 0;
				clubs[ 'tous' ].femme = 0;
				clubs[ 'tous' ].nbTry = 0;
				clubs[ 'tous' ].win = 0;

				for ( let i = 0; i < clubList.length; i++ )
				{
					clubs[ 'tous' ].microbe += clubs[ clubList[ i ] ].microbe;
					clubs[ 'tous' ].poussin += clubs[ clubList[ i ] ].poussin;
					clubs[ 'tous' ].bejamin += clubs[ clubList[ i ] ].bejamin;
					clubs[ 'tous' ].minime += clubs[ clubList[ i ] ].minime;
					clubs[ 'tous' ].cadet += clubs[ clubList[ i ] ].cadet;
					clubs[ 'tous' ].senior += clubs[ clubList[ i ] ].senior;
					clubs[ 'tous' ].veterant += clubs[ clubList[ i ] ].veterant;
					clubs[ 'tous' ].homme += clubs[ clubList[ i ] ].homme;
					clubs[ 'tous' ].femme += clubs[ clubList[ i ] ].femme;
					clubs[ 'tous' ].nbTry += clubs[ clubList[ i ] ].nbTry;
					clubs[ 'tous' ].win += clubs[ clubList[ i ] ].win;
				}
				console.log( clubs );
			}

			function calcAverage ( )
			{
				average = [];
				for ( let i = 0; i < voie.length; i++ )
				{
					average[ i ] = {};
					average[ i ].name = voie[ i ].name;
					average[ i ].nbTry = 0;
					average[ i ].nbPlayerTestIt = 0;
					average[ i ].total = 0;
					average[ i ].success = 0;
					player = 0;
					switch ( voie[ i ].type )
					{
						case 'bloc':
						{
							average[ i ].max = voie[ i ].score.fin;
							break;
						}
						case 'diff':
						{
							if ( voie[ i ].score.tete )
							{
								average[ i ].max = voie[ i ].score.tete[ voie[ i ].score.tete.length - 1 ];
							}
							else
							{
								average[ i ].max = voie[ i ].score.moul[ voie[ i ].score.moul.length - 1 ];
							}
							break;
						}
						case 'vitesse':
						{
							average[ i ].max = voie[ i ].score.time;
							break;
						}
						case 'slack':
						{
							average[ i ].max = voie[ i ].score.distance;
							break;
						}
					}
				}

				for ( let i = 0; i < users.length; i++ )
				{
					if ( !score[ users[ i ].name ])
					{
						continue;
					}
					player++;

					for ( let j = 0; j < voie.length; j++ )
					{
						average[ j ].nbTry += getNbTests ( users[ i ].name, j ) | 0;
						average[ j ].total += getScore ( users[ i ].name, j ) | 0;
						average[ j ].nbPlayerTestIt += ( getNbTests ( users[ i ].name, j ) )? 1 : 0;;

						if ( ( voie[ j ].type != 'vitesse' ) &&
							( getScore ( users[ i ].name, j ) == parseFloat ( average[ j ].max ) ) )
						{
							average[ j ].success++;
						}
					}
				}
				drawCurves ( );
			}

			calcAverage ( );
		</script>
	</body>
</html>
