<!DOCTYPE html>
<html>
	<%- include("partials/head.html") -%>
	<body>
		<%- include("partials/nav.html") -%>
		<section>
			<form>
				<div>
					<label for="voie">Nom de voies existantes</label>
					<select id="voie"></select>
				</div>
			</form>
			<form>
				<div>
					<label for="newVoie">Nom de la nouvelle voie</label>
					<input id="newVoie" type="text">
				</div>
				<div>
					<label for="type">Type de voie</label>
					<select id="type"></select>
				</div>
				<div>
					<label>Pour quelles categories</label>
					<ul id="categories"></ul>
				</div>
				<% if ( "a" == locals?.mode?.[ 0 ] ) { %>
				<div>
					<label for="scores">Score</label>
					<input id="scores"></input>
					<span>Les differents scores doivent être separé par un point, une virgule ou un espace</span>
				</div>
				<% } %>
				<textarea id="comments" placeholder="commentaires"></textarea>
				<p id="serverMsg"></p>
				<input id="img" type="file" accept="image/*" capture="environement">
				<button id="validate">Sauver</button>
			</form>
		</section>
		<script type="text/javascript" nonce="<%- locals.nonce %>" src="/js/utils.js"></script>
		<script nonce="<%- locals.nonce %>">
			let domEls = {
				type:  document.getElementById ( "type" ),
				voie:  document.getElementById ( "voie" ),
				newVoie:  document.getElementById ( "newVoie" ),
				validate: document.getElementById ( "validate" ),
				scores: document.getElementById ( "scores" ),
				img: document.getElementById ( "img" ),
				comments: document.getElementById ( "comments" ),
				serverMsg: document.getElementById ( "serverMsg" ),
				categories: document.getElementById ( "categories" ),
			};

			let socket = io ( );

			let categories = {};
			
			socket.on ( "connect", ()=>{
				socket.emit ( "getListOfAllTypes" );
				socket.emit ( "getVoies", {} );
				socket.emit ( "getListOfAllCategories" );
			});

			socket.on ( "setVoies", (msg)=>{
				uOneSlector ( {default:"--", selector:domEls.voie, list:msg} )

				domEls.voie.options[ 0 ].disabled = true;
			});

			socket.on ( "setListOfAllTypes", (msg)=>{
				uOneSlector ( {default:"--", selector:domEls.type, list:msg} )
				domEls.type.options[ 0 ].disabled = true;
			});

			socket.on ( "error", (msg)=>{
				domEls.serverMsg.display = "";
				domEls.serverMsg.innerText = msg;

				document.body.style.backgroundColor = "red";

				setTimeout ( ()=>{
					document.body.style.backgroundColor = "";
				}, 1000 );
			});

			socket.on ( "ok", ()=>{
				domEls.scores.value = "";
				domEls.newVoie.value = "";
				domEls.comments.value = "";
				domEls.img.value = "";

				document.body.style.backgroundColor = "green";

				setTimeout ( ()=>{
					document.body.style.backgroundColor = "";
				}, 1000 );
			});

			socket.on ( "setListOfAllCategories", (msg)=>
			{
				while ( domEls.categories.firstChild )
				{
					domEls.categories.removeChild ( domEls.categories.lastChild );
				}

				categories = {};

				for ( let cat of msg )
				{
					let div = document.createElement( "li" );
					domEls.categories.appendChild ( div );

					let input = document.createElement ( "input" );
					div.appendChild ( input );
					input.type = "checkbox",
					input.id = "cat_"+cat;
					input.checked = true;
					categories[ cat ] = true;

					let label = document.createElement ( "label" );
					div.appendChild ( label );
					label.htmlFor = "cat_"+cat;;
					label.innerText = " "+cat;

					input.addEventListener ( "change", (ev)=>{
						categories[ cat ] = ev.target.checked;
					});
				}
			});

			domEls.validate.addEventListener ( "click", (ev)=>{
				ev.preventDefault ( );

				let out = {
					voie: domEls.newVoie.value,
					type: domEls.type.value,
					comments: domEls.comments.value,
					categories: categories,
				};

				if ( domEls.scores )
				{
					out.score = domEls.scores.value;
				}

				let files = domEls.img.files;

				// FileReader support
				if (FileReader && files && files.length)
				{
					let fr = new FileReader();
					fr.onload = function (ev) {
						out.img = fr.result;
						socket.emit ( "newVoie", out );
					}
					fr.onerror = function (ev) {
						socket.emit ( "newVoie", out );
					}
					fr.readAsDataURL(files[0]);
				}
				else
				{
					socket.emit ( "newVoie", out );
				}
			});
		</script>
	</body>
</html>